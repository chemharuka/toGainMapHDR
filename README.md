# Convert HDR files to Gain Map HDR

A macOS tool for converting HDR files to Adaptive (Gain Map) HDR / ISO HDR.

Include:

1. toGainMapHDR, which convert png, tiff etc. HDR file to Adaptive HDR (gain map heic file) / ISO HDR (PQ or HLG curve image). The program will read a image as both SDR and HDR image, then calculate difference between two images as gain map.
2. heic_hdr.py, a ChatGPT generated python script to convert all TIFF file to HEIC.
3. GainMapKernel.ci.metallib, library needed to output Apple gain map.

GUI program created by @vincenttsang [HDR-Gain-Map-Convert](https://github.com/vincenttsang/HDR-Gain-Map-Convert)

Lightroom Plugin created by @fengshenx [LR_GainMap_HDR_Export_Plugin](https://github.com/fengshenx/LR_GainMap_HDR_Export_Plugin)

## Usage

### toGainMapHDR

Convert any HDR Files to Gain_Map_HDR.heic by toGainMapHDR:

`./toGainMapHDR $file_dir $folder_dir $options`

Supported input format: 

* AVIF、JXL、HEIF (in PQ/HLG/gain map)
* TIFF (in PQ/HLG/Linear32)
* PNG (in PQ/HLG)
* JPG (gain map)
* EXR、HDR

Supported output format: 

* ISO Gain Map HDR in HEIC/JPG (default)
* Apple Gain Map HDR in HEIC/JPG
* PQ/HLG HDR in HEIC
* Tone mapped SDR in HEIC/JPG

(Note: Some formats have width/height limitation, only support the image file which could be openned by preview.app)

#### System Require

Require macOS 15.0+.

PLEASE UPGRADE your system to LATEST version for more compatibility.

PLEASE UPGRADE your system to LATEST version for more compatibility.

#### Options:

-q \<value>: image quality (default: 0.85)

-r \<value>: tone mapping ratio (between 0 and 1, default: 0.2)

    ratio = 0: keep full highlight details
    ratio = 1: hard clip all parts exceeding SDR range

-b \<file_path>: specify the base image and output in RGB gain map format.

-t \<text>: add extra text after the output file name.

-c \<color space>: specify output color space (srgb, p3, rec2020)

-d \<color depth>: specify output color depth (default: 8)

-g: output Apple gain map HDR, which generated by CIFilter \*\*

-a: output Apple gain map HDR, which generated from ISO gain map \*\*

-H \<value>: scaling ratio for Apple gain map, (between 1.0 and 2.0, default: 1.0)

    ratio = 1.0: full size gain map
    ratio = 2.0: half width/height gain map

-s: export tone mapped SDR image without HDR gain map

-p: export 10-bit PQ HDR heic image

-h: export HLG HDR heic image (default in 10-bit)

-j: export image in JPEG format (work with SDR or gain map HDR exporting)

-help: print help information

#### File Size and Quality

Input image: Half Dome sunset, 16-bit TIFF, 4000x6000 px, 144 MB.

| options                            | JPG     | HEIC       | PSNR/dB | PSNR/dB |
| ---------------------------------- | ------- | ---------- | ------- | ------- |
| -p (PQ HDR 10 bit)                 | -       | **5.6 MB** |         | 43.93   |
| -p -q 100                          | -       | 21.5 MB    |         | 50.42   |
| -h -d 8 (HLG 8 bit)                | -       | 3.3 MB     |         | ≈40.14  |
| -h (HLG 10 bit)                    | -       | 7.4 MB     |         | ≈44.82  |
| -s (SDR image)                     | 7.5 MB  | **3.9 MB** | 27.94   | 27.83   |
| -g (Apple HDR 1)                   | 11.1 MB | 6.5 MB     | 40.83   | 39.47*  |
| -g -H 1.5 (Apple HDR 1 with scale) | 9.2 MB  | **5.2 MB** | 40.62   | 39.25*  |
| -g -H 2.0 (Apple HDR 1 with scale) | 8.4 MB  | 4.6 MB     | 40.66   | 39.27*  |
| -g -d 10 (Apple HDR 1 in 10 bit)   | -       | 11.0 MB    |         | 42.38*  |
| -g -H 1.5 -d 10                    | -       | 9.7 MB     |         | 42.08*  |
| -a (Apple HDR 2)                   | 11.4 MB | 7 MB       | 43.03   | 41.11   |
| -a -H 1.5 (Apple HDR 2 with scale) | 9.4 MB  | **5.4 MB** | 42.84   | 40.88   |
| -a -H 2.0 (Apple HDR 2 with scale) | 8.5 MB  | 4.7 MB     | 42.86   | 40.88   |
| -a -H 1.5 -d 10                    | -       | 9.9 MB     |         | 45.66   |
| default (ISO Gain Map HDR)         | 11.5 MB | 7.4 MB     | 43.03   | 41.43   |
| -d 10 (ISO Gain Map HDR in 10 bit) | -       | 11.9 MB    |         | 46.08   |
| -q 100 (ISO Gain Map best quality) | 27.5 MB | 26.4 MB    | 48.75   | 48.49   |

Note*: Apple gain map generated from CIFilter will cause slight brightness/gamma differences, which leads to lower PSNR. but this does not mean that details are lost.

Compare with other HDR formats exported by LR.

| Format                          | Size       | PSNR/dB |
| ------------------------------- | ---------- | ------- |
| UltraHDR (quality 60)           | 5.1 MB     | 36.96   |
| UltraHDR (quality 85)           | 19.7 MB    | 45.58   |
| AVIF (quality 70 with gain map) | 4.7 MB     | 38.65   |
| AVIF (quality 85 with gain map) | 7.3 MB     | 41.37   |
| AVIF (quality 85, PQ HDR)       | 1.9 MB     | 37.76   |
| AVIF (quality 95, PQ HDR)       | **2.7 MB** | 39.63   |
| AVIF (quality 100, PQ HDR)      | 7.7 MB     | 46.31   |
| JXL (quality 85, PQ HDR)        | 4.9 MB     | 41.30   |



#### Sample images for options

Quality for 8 bit heic SDR export: (-s -q 0.2~1.0)

| -s -q                                                        |                                                              |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| quality0.2    34.22 dB                                       | quality0.4    37.78 dB                                       | quality0.6    41.34 dB                                       |
| ![test-q=0 2](https://github.com/user-attachments/assets/f6916630-e607-4393-94ab-531b01217f2f) | ![test-q=0 4](https://github.com/user-attachments/assets/78735c04-91ee-42e8-8793-b4bb4a13f5cf) | ![test-q=0 6](https://github.com/user-attachments/assets/2ce8b0c5-5557-4eb2-a915-6355bdd45005) |
| quality0.8    45.33 dB                                       | quality1.0    50.31 dB                                       |                                                              |
| ![test-q=0 8](https://github.com/user-attachments/assets/e0a5813c-c812-413c-b3bc-a395f737e92b) | ![test-q=1.0](https://github.com/user-attachments/assets/a706bc60-8ef3-48bc-a878-6aa5f1be384b) |                                                              |

SDR mapping ratio for jpg SDR export: (-s -j -r 0.0~1.0)

| ratio0.0                                                     | ratio0.2                                                     | ratio0.4                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![test-r0 0](https://github.com/user-attachments/assets/1bd22c94-450e-41b3-95ba-1330d9165c63) | ![test-r0 2](https://github.com/user-attachments/assets/374c8192-0afc-4896-8c2a-0aee90bc0182) | ![test-r0 4](https://github.com/user-attachments/assets/edfd9788-3feb-43b7-b619-6d21c6c2995f) |
| ratio0.6                                                     | ratio0.8                                                     | ratio1.0                                                     |
| ![test-r0 6](https://github.com/user-attachments/assets/2ea09c40-5a1a-4cd2-b079-5447663cc629) | ![test-r0 8](https://github.com/user-attachments/assets/2d8ebd20-7968-4e6f-b4e2-677fefcee83d) | ![test-r1 0](https://github.com/user-attachments/assets/818771a5-c3ab-4c6d-a264-d2eba37b93e0) |


HDR export: (-j -r 0.0~1.0). Edge.app on macOS not support RGB HDR, view HDR effect on Safari.app.

| ratio0.0 | ratio0.2  | ratio0.4 |
| -------- | --------- | -------- |
| ![test-hdr-0 0](https://github.com/user-attachments/assets/7b53bb9f-bfe6-418c-9e29-c2285f4d7bc8) | ![test-hdr-0 2](https://github.com/user-attachments/assets/1c8c6fb1-bd78-4966-9ddc-0fd48911b38c) | ![test-hdr-0 4](https://github.com/user-attachments/assets/7245b902-7bcc-4ebf-b84a-e60dd1807253) |
| ratio0.6 | ratio0.8 | ratio1.0|
| ![test-hdr-0 6](https://github.com/user-attachments/assets/2fd00f49-ef87-4b05-8b4c-6083724c2394) | ![test-hdr-0 8](https://github.com/user-attachments/assets/64045808-6d75-410b-bc4e-1eb4bad9397e) | ![test-hdr-1 0](https://github.com/user-attachments/assets/a32fa542-9616-48ae-b625-cdbcb6a23c0d)|

Apple Gain Map scaling ratio: (-j -g -H1.0~2.0).

| H1.0 725K | H1.2 644K  | H1.4 606K |
| -------- | --------- | -------- |
| ![test-g-H1 0](https://github.com/user-attachments/assets/2562d159-0843-4ae9-b8f6-e7cc8c9dd67e) | ![test-g-H1 2](https://github.com/user-attachments/assets/34eca108-a873-4a2a-9cc6-828415dc33ed) | ![test-g-H1 4](https://github.com/user-attachments/assets/5ffe1615-781d-4599-b878-e2e7f39cc31d) |
| H1.6 574K | H1.8 536K  | H2.0 556K |
| ![test-g-H1 6](https://github.com/user-attachments/assets/04c4d28c-85cf-453b-bf37-83f267f9f817) | ![test-g-H2 0](https://github.com/user-attachments/assets/3577201f-175e-43b1-87c8-693e163013e2) | ![test-g-H1 8](https://github.com/user-attachments/assets/6f0788a4-d44f-4ee1-b463-c197d5004806) |


#### Sample command：

 `./toGainMapHDR ~/Downloads/abc.png ~/Documents/ -q 0.95 -d 10 -c rec2020`

 `./toGainMapHDR ~/Downloads/abc.tiff ~/Documents/ -q 0.80 -j`

convert gain map abc.avif to gain map heic file and keep base image:

 `./toGainMapHDR ~/Downloads/abc.avif ~/Documents/ -b ./Downloads/abc.avif` 

convert abc.tiff to Apple HDR by CIFilter and scale gain map to 0.67x:

 `./toGainMapHDR ~/Downloads/abc.tiff ~/Documents/ -g -H 1.5` 

convert abc.tiff to Apple HDR from ISO gain map (less compatibility):

 `./toGainMapHDR ~/Downloads/abc.tiff ~/Documents/ -a` 

convert abc.tiff to HLG HDR file:

 `./toGainMapHDR ~/Downloads/abc.tiff ~/Documents/ -h` 

convert RGB gain map (adaptive HDR) file to monochrome gain map (Apple HDR) heic file:

 `./toGainMapHDR ~/Downloads/abc.heic ~/Downloads/ -g -t -mono` 

#### Note: 

1. Using a specific base photo will result larger file size
2. Scaling the gain map can reduce file size, with slightly lose highlight detail
3. \*\* Monochrome gain map compatible with Google Photos (Android version), Instagram, Edge Browser etc. Recommended to use for sharing. The two different type have slight differences in compatibility. It is recommended to use the first one (-g).
4. When exporting 8-bit heic image, color discontinuity may occur in low-texture areas, like clouds, lakes.

### heic_hdr.py

Batch convert all tiff files in a folder by heic_hdr.py:

1. Clone \bin to a folder (or download them from release):

`git clone https://github.com/chemharuka/toGainMapHDR.git`

`cd toGainMapHDR/bin`

`chmod 711 ./toGainMapHDR`

2. run heic_hdr.py (default run with 8 threads, change it accroding to your chip's performance cores.)

`python3 ./heic_hdr.py $folder_for_convert $options`

You may need to change the **DIR** of toGainMapHDR in heic_hdr.py before running. (in line 44)

#### Sample：

`python3 ./heic_hdr.py ~/Documents/export/ -q 0.90 -c rec2020 -g`

#### Note: 

1. Not support specifying base image in batch converting.

## Sample

Sample Apple Gain Map HDR files: (options: -g, ONLY this format supported by Edge Browser on macOS)

Sample 1: (Wu-kung Mountains as UNSECO Geopark, Jiangxi, China)
![DJI_1_0616_D](https://github.com/user-attachments/assets/d4fd48bb-6561-496f-b1ab-083ee1ae8a95)

Sample 2: (Sanqing Mountain as World Heritage, Jiangxi, China)
![DJI_1_0226_D](https://github.com/user-attachments/assets/0a718722-6939-41d3-844d-14517442de05)

Sample 3: (Kanbula National Park, Qinghai, China)
![DJI_1_0927_D](https://github.com/user-attachments/assets/66da879e-d56a-4bae-8185-d2d7d462e10f)

## Known Issue

HDR decoding path mis-handle when large AVIF image (long edge ≥ 8192) as input on Intel Mac. This is a problem with the system's built-in function and may be fixed in a future system version.
 You can export image as PQ HDR then input generated PQ HDR image.

